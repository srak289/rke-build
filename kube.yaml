- hosts: kubernetes
  become: True
  gather_facts: False
  tasks:
    - name: Open Firewall
      ansible.builtin.shell:
        cmd: |
          firewall-cmd --add-port=6443/tcp
          firewall-cmd --add-port=6443/tcp --permanent
          firewall-cmd --add-port=10250/tcp
          firewall-cmd --add-port=10250/tcp --permanent
          modprobe br_netfilter
          sysctl -w net.bridge.bridge-nf-call-iptables=1
          sysctl -w net.ipv4.ip_forward=1
          swapoff -a

    - name: Add Kubernetes Repo
      ansible.builtin.copy:
        content: |
          [kubernetes]
          name=Kubernetes
          baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/
          enabled=1
          gpgcheck=1
          gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key
          exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
        dest: /etc/yum.repos.d/kubernetes.repo

    - name: Add Docker-CE Repo
      ansible.builtin.shell:
        cmd: |
          dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

    - name: Disable SELinux per docs
      ansible.builtin.shell:
        cmd: |
          setenforce 0

    - name: Install Kubernetes and Deps
      ansible.builtin.dnf:
        name:
          - 'https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.8/cri-dockerd-0.3.8-3.el8.x86_64.rpm'
          - kubeadm
          - kubectl
          - kubelet
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
          - containernetworking-plugins
        state: present
        update_cache: True
        disable_gpg_check: True
        disable_excludes: kubernetes

    - name: Activate docker.socket
      ansible.builtin.systemd:
        name: docker.socket
        state: restarted
        enabled: True
        daemon_reload: True

    - name: Activate cri-docker.socket
      ansible.builtin.systemd:
        name: cri-docker.socket
        state: restarted
        enabled: True
        daemon_reload: True

    - name: Enable kubelet
      ansible.builtin.systemd:
        name: kubelet
        state: restarted
        enabled: True

    - name: Check steve
      ansible.builtin.stat:
        path: /home/steve
      register: steve

    - name: Add user steve
      ansible.builtin.include_tasks:
        file: steve.yaml
      when: not steve.stat.exists
